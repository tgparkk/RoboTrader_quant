# 퀀트 투자 전략 전환 가이드

## 목차
1. [퀀트 투자란?](#1-퀀트-투자란)
2. [이전 프로그램과의 차이점](#2-이전-프로그램과의-차이점)
3. [지금까지 구현한 내용](#3-지금까지-구현한-내용)
4. [앞으로 구현할 내용](#4-앞으로-구현할-내용)
5. [전환 과정 및 설정](#5-전환-과정-및-설정)

---

## 1. 퀀트 투자란?

### 1.1 퀀트 투자의 개념

**퀀트 투자(Quantitative Investing)**는 수학적·통계적 방법을 사용하여 투자 의사결정을 내리는 체계적인 투자 방식입니다.

**핵심 원리:**
- **데이터 기반 의사결정**: 감이나 직관이 아닌 객관적 데이터와 통계 분석
- **팩터 기반 선정**: 여러 재무/가격 지표(팩터)를 종합하여 종목 선정
- **시스템적 접근**: 일관된 규칙에 따라 자동으로 포트폴리오 구성 및 관리
- **리밸런싱**: 정기적으로 포트폴리오를 재구성하여 최적 상태 유지

### 1.2 본 시스템의 퀀트 전략

**4개 팩터 기반 종합 스코어링:**

1. **Value 팩터 (30%)** - 저평가 종목 선별
   - PER, PBR, PSR, PCR, EV/EBITDA 등 밸류에이션 지표
   - 업종 평균 대비 상대 평가
   - 낮을수록 고득점 (저평가 우선)

2. **Momentum 팩터 (30%)** - 상승 추세 종목 선별
   - 1개월/3개월/6개월/12개월 수익률
   - RSI(14) 과매수/과매도 분석
   - 최근 상승세가 강한 종목 우선

3. **Quality 팩터 (20%)** - 재무 건전성 평가
   - ROE, ROA (수익성)
   - 부채비율, 유동비율 (안정성)
   - 영업이익률 (수익성)

4. **Growth 팩터 (20%)** - 성장성 평가
   - 매출 성장률 (1년/3년)
   - 순이익 성장률
   - EPS 성장률

**최종 점수 계산:**
```
최종 점수 = Value(30%) + Momentum(30%) + Quality(20%) + Growth(20%)
```

**종목 선정:**
- 전체 종목 중 상위 50개 선정
- 동점 시 Momentum 점수 우선

### 1.3 리밸런싱 시스템

**리밸런싱(Rebalancing)**이란 포트폴리오를 정기적으로 재구성하는 것입니다.

**본 시스템의 리밸런싱 방식:**
1. **매일 15:40**: 퀀트 스크리닝 실행 → 상위 50개 종목 선정
2. **익일 09:05**: 리밸런싱 실행
   - 현재 보유 종목 vs 목표 포트폴리오(상위 50개) 비교
   - **매도**: 보유 중이지만 목표 포트에 없는 종목 → 시장가 전량 매도
   - **매수**: 목표 포트에 있지만 보유하지 않은 종목 → 동등 비중 시장가 매수
3. **장중**: 보유 종목 모니터링 (손절/익절 판단만)

**리밸런싱 주기:**
- 일간 리밸런싱 (기본값)
- 주간 리밸런싱 (매주 월요일)
- 월간 리밸런싱 (매월 1일)

---

## 2. 이전 프로그램과의 차이점

### 2.1 매매 방식

| 구분 | 이전 프로그램 (단타 거래) | 현재 프로그램 (퀀트 투자) |
|------|-------------------------|------------------------|
| **매수 타이밍** | 장중 실시간 매수 판단 (3분봉 완성 후) | 09:05 리밸런싱으로 한 번에 매수 |
| **매수 기준** | 기술적 지표 (가격박스, 이등분선, 볼린저밴드 등) | 퀀트 팩터 점수 (Value, Momentum, Quality, Growth) |
| **데이터 수집** | 분봉 데이터 (1분봉, 3분봉) | 일봉 데이터 (리밸런싱 모드) |
| **포지션 구성** | 실시간 기회 포착 | 정기적 리밸런싱 |
| **종목 선정** | 조건검색 + 실시간 추가 | 15:40 스크리닝으로 상위 50개 선정 |

### 2.2 데이터 수집 방식

**이전 프로그램:**
- 장중 선정된 종목: 08:00부터 선정시점까지 **전체 분봉 데이터** 수집
- 실시간 분봉 데이터 업데이트 (1분봉)
- 3분봉 변환하여 매수 판단

**현재 프로그램 (리밸런싱 모드):**
- 장중 선정된 종목: **일봉 데이터만** 수집
- 분봉 데이터 수집 스킵 (API 호출 감소)
- 09:05 리밸런싱으로 매수하므로 분봉 데이터 불필요

### 2.3 모니터링 대상

**이전 프로그램:**
- 조건검색으로 선정된 종목
- 실시간으로 추가되는 후보 종목
- 동적으로 변하는 모니터링 대상

**현재 프로그램 (리밸런싱 모드):**
- 리밸런싱으로 선정된 50개 종목만 모니터링
- 고정된 포트폴리오 구성
- 장중에는 매수 판단 없음 (매도 판단만)

### 2.4 전략 복잡도

**이전 프로그램:**
- 다중 전략 혼합 (가격박스, 이등분선, 볼린저밴드, 눌림목 패턴 등)
- 실시간 신호 생성 및 판단
- 복잡한 타이밍 제어

**현재 프로그램:**
- 단일 퀀트 전략 (4개 팩터 종합)
- 리밸런싱 기반 포지션 구성
- 단순하고 일관된 규칙

### 2.5 장단점 비교

**이전 프로그램 (단타 거래)의 장점:**
- ✅ 실시간 기회 포착 가능
- ✅ 빠른 진입/청산
- ✅ 유연한 전략 운영

**이전 프로그램의 단점:**
- ❌ 복잡한 로직 관리
- ❌ 감정적 의사결정 가능성
- ❌ 높은 거래 비용

**현재 프로그램 (퀀트 투자)의 장점:**
- ✅ 체계적이고 객관적
- ✅ 낮은 거래 빈도 (비용 절감)
- ✅ 백테스트 가능
- ✅ 일관된 전략 실행

**현재 프로그램의 단점:**
- ❌ 실시간 기회 포착 불가
- ❌ 리밸런싱 주기 고정

---

## 3. 지금까지 구현한 내용

### 3.1 데이터 수집 인프라 (1단계)

**✅ 재무 데이터 API 연동**
- `api/kis_financial_api.py`: KIS 재무비율, 손익계산서 API 연동
- `db/database_manager.py`: `financial_data` 테이블 생성 및 저장
- 재무 데이터 수집 및 캐싱 로직 구현

**✅ 과거 가격 데이터 수집**
- 일봉 데이터 조회 함수 구현
- DB 저장 및 조회 기능

### 3.2 1차 필터링 로직 (2단계)

**✅ 기본 필터링 조건 구현**
- 시가총액 ≥ 1,000억원
- 최근 20일 일평균 거래대금 ≥ 10억원
- 주가 범위: 1,000원 ~ 500,000원
- 상장 ≥ 250 거래일
- 재무데이터 존재 확인
- 통계 로깅 (제외 사유 TOP5)

### 3.3 팩터 점수 계산 (3~6단계)

**✅ Value 팩터 (30%)**
- PER, PBR, PSR 점수화
- EPS/BPS 음수 처리 (0점)
- 업종 평균 대비 상대 평가
- ⚠️ PCR, EV/EBITDA는 추후 데이터 확충 시 추가 예정

**✅ Momentum 팩터 (30%)**
- 1M/3M/6M/12M 수익률 계산
- RSI(14) 계산 및 점수화
- 가중치: 1M(15%) + 3M(25%) + 6M(30%) + 12M(20%) + RSI(10%)

**✅ Quality 팩터 (20%)**
- ROE, ROA 점수화
- 부채비율, 유동비율 점수화
- 영업이익률 점수화
- 가중치: ROE(30%) + ROA(20%) + 부채비율(20%) + 유동비율(15%) + 영업이익률(15%)

**✅ Growth 팩터 (20%)**
- 매출 성장률 (1년/3년)
- 순이익 성장률
- EPS 성장률
- 가중치: 1년 매출(30%) + 3년 매출(25%) + 1년 순이익(25%) + 1년 EPS(20%)

### 3.4 종합 스코어링 시스템 (7단계)

**✅ 4개 팩터 통합**
- 최종 점수 = Value(30%) + Momentum(30%) + Quality(20%) + Growth(20%)
- 동점 시 Momentum 점수 우선 정렬
- 상위 50개 종목 선정 및 DB 저장

### 3.5 스크리닝 스케줄러 (8단계)

**✅ 일일 스크리닝 루틴**
- 매일 15:40 자동 실행
- 전체 종목 → 필터링 → 팩터 계산 → 순위 → 저장
- 오류 재시도 (기본 3회)
- 상위 5개 종목 텔레그램 알림

### 3.6 리밸런싱 시스템 (9단계)

**✅ 리밸런싱 서비스 구현**
- `core/quant/quant_rebalancing_service.py`
- 보유 vs 목표 포트 비교
- 매도/매수/유지 리스트 산출
- 동등 비중 매수 계산
- 일간/주간/월간 주기 지원

**✅ 리밸런싱 실행 로직**
- `main.py`에 `_rebalancing_task()` 태스크 추가
- 09:05 시점에 리밸런싱 계획 계산 및 실행
- 매도 → 매수 순서로 진행
- 시장가 주문 실행

### 3.7 데이터 수집 최적화 (2025-11-18)

**✅ 리밸런싱 모드 지원**
- `config/trading_config.json`에 `rebalancing_mode` 설정 추가
- 리밸런싱 모드일 때 일봉 데이터만 수집
- 분봉 데이터 수집 스킵 (API 호출 감소)

### 3.8 실행 환경 개선

**✅ 배치 파일 개선**
- `run_robotrader.bat`: UTF-8 모드, 로그 파일 자동 생성
- PID 파일 관리 (`robotrader_quant.pid`)
- 의존성 자동 설치

**✅ 가상 매매 모드**
- `config/trading_config.json`: `"paper_trading": true` (기본값)
- 실제 매매 전환 시 `"paper_trading": false`로 설정

---

## 4. 앞으로 구현할 내용

### 4.1 팩터 계산 정밀화 (우선순위: 높음)

**Value 팩터 보완:**
- [ ] PCR (Price-to-Cash Flow Ratio) 점수 계산 추가
- [ ] EV/EBITDA 점수 계산 추가
- [ ] 업종별 평균값 계산 정확도 향상

**Growth 팩터 보완:**
- [ ] 손익계산서 API 응답 기반 연간/분기 성장률 계산
- [ ] 성장률 점수화 기준 세분화

### 4.2 리밸런싱 모드 완전 전환 (우선순위: 높음)

**현재 상태:**
- ⚠️ 리밸런싱 시스템은 구현되었지만
- ⚠️ 실시간 매수 판단도 여전히 활성화됨 (하이브리드 방식)

**구현 필요:**
- [ ] 순수 리밸런싱 모드 구현
  - `_check_condition_search()` 비활성화 (또는 리밸런싱 모드에서만 스킵)
  - `_analyze_buy_decision()` 호출 조건 수정 (리밸런싱 종목만)
  - 장중 매수 판단 비활성화
- [ ] 리밸런싱 모드 설정으로 전환/복귀 가능하도록 구현

### 4.3 리밸런싱 실행 개선 (우선순위: 중간)

**현재 구현:**
- ✅ 리밸런싱 계획 계산
- ✅ 리밸런싱 실행 (매도 → 매수)

**개선 필요:**
- [ ] 매도 완료 대기 로직 개선 (현재는 고정 5분 대기)
- [ ] 매도 주문 체결 확인 후 매수 실행
- [ ] 예약 주문 기능 (익일 09:05 자동 실행)

### 4.4 모니터링 및 알림 강화 (우선순위: 중간)

**구현 필요:**
- [ ] 리밸런싱 결과 상세 알림
  - 매도 종목 및 수량
  - 매수 종목 및 수량
  - 주문 성공/실패 현황
- [ ] 일일 포트폴리오 성과 리포트
- [ ] 팩터 점수 변동 추적

### 4.5 백테스트 시스템 (우선순위: 중간)

**현재 상태:**
- ✅ `backtests/quant_monthly_backtest.py` 기본 구조 존재

**개선 필요:**
- [ ] 일간 리밸런싱 백테스트 구현
- [ ] 주간 리밸런싱 백테스트 구현
- [ ] 성과 지표 계산 (수익률, MDD, 샤프 비율 등)
- [ ] 벤치마크(KOSPI) 대비 비교

### 4.6 단위 테스트 보완 (우선순위: 낮음)

**현재 상태:**
- ✅ `tests/test_quant_factors.py` (팩터/점수 검증)
- ✅ `tests/test_primary_filter.py` (1차 필터)
- ✅ `tests/test_rebalancing.py` (리밸런싱 계획/실행)

**보완 필요:**
- [ ] 경계값 테스트 추가
- [ ] 예외 처리 테스트 추가
- [ ] 통합 테스트 추가

### 4.7 데이터 품질 관리 (우선순위: 낮음)

**구현 필요:**
- [ ] 재무 데이터 유효성 검증
- [ ] 가격 데이터 이상치 감지
- [ ] 데이터 누락 시 자동 재수집

---

## 5. 전환 과정 및 설정

### 5.1 현재 상태

**하이브리드 모드 (기본값):**
- 리밸런싱 시스템 + 실시간 매수 판단 병행
- `config/trading_config.json`:
  ```json
  {
    "rebalancing_mode": false,
    "paper_trading": true
  }
  ```

### 5.2 순수 리밸런싱 모드로 전환

**설정 변경:**
```json
{
  "rebalancing_mode": true,
  "paper_trading": true
}
```

**변경 사항:**
1. 장중 선정된 종목: 일봉 데이터만 수집 (분봉 데이터 스킵)
2. 실시간 매수 판단 비활성화
3. 리밸런싱으로 선정된 50개 종목만 모니터링
4. 장중에는 매도 판단만 실행 (손절/익절)

### 5.3 실제 매매 모드로 전환

**설정 변경:**
```json
{
  "rebalancing_mode": true,
  "paper_trading": false
}
```

**주의사항:**
- ⚠️ 실제 자금이 사용됩니다
- ⚠️ 충분한 테스트 후 전환 권장
- ⚠️ 초기 자금은 소액으로 시작 권장

### 5.4 전환 체크리스트

**리밸런싱 모드 전환 전:**
- [ ] 백테스트 결과 검토
- [ ] 리밸런싱 로직 검증
- [ ] 가상 매매 모드로 충분한 테스트
- [ ] 리밸런싱 실행 로그 확인

**실제 매매 모드 전환 전:**
- [ ] 가상 매매 모드로 최소 1주일 운영
- [ ] 리밸런싱 실행 정상 동작 확인
- [ ] 손절/익절 로직 검증
- [ ] 계좌 잔고 및 한도 확인

---

## 6. 참고 문서

- `docs/quant_strategy_plan.md`: 퀀트 전략 구현 작업 순서
- `docs/quant_rebuild_progress.md`: 퀀트 전략 전환 진행 현황
- `docs/quant_implementation_gap.md`: 문서 의도 vs 현재 구현 차이점

---

## 7. 문의 및 지원

전환 과정에서 문제가 발생하거나 질문이 있으시면:
1. 로그 파일 확인 (`logs/robotrader_quant_*.log`)
2. 설정 파일 확인 (`config/trading_config.json`)
3. DB 데이터 확인 (`data/robotrader.db`)

---

**최종 업데이트: 2025-11-18**

